import type { MyContext } from '../types.js';
import logger from '../utils/logger.js';

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞ –±–∏–ª–µ—Ç–æ–≤
export const searchHandler = async (ctx: MyContext) => {
	try {
		// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∏—Å–∫–∞ –±–∏–ª–µ—Ç–æ–≤
		logger.info('Ticket search process started... üéüÔ∏è');

		// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–µ—Ç–æ–¥–∞ reply –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
		if (typeof ctx.reply !== 'function') {
			// –ï—Å–ª–∏ –º–µ—Ç–æ–¥ reply –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
			logger.error('[‚ö†Ô∏è] Context does not contain method reply.');
		}

		// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ—Å—Å–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
		if (!ctx.session) {
			// –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
			logger.warn('[‚ö†Ô∏è] Session property was missing, initializing with an empty object.');
			ctx.session = {}; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏
		}

		// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞
		logger.debug('[‚úàÔ∏è] Requesting departure city from the user.');

		// –ó–∞–ø—Ä–æ—Å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞
		await ctx.reply('–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –≤—ã –≤—ã–ª–µ—Ç–∞–µ—Ç–µ?');

		// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è —Ç–µ–∫—É—â–∏–π —à–∞–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–±–æ—Ä–∞
		ctx.session = {
			...ctx.session,
			step: 'from_city', // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à–∞–≥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ 'from_city'
		};
	} catch (error) {
		// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞
		logger.error('[‚ùå] Error requesting departure city:', error);

		// –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —è–≤–ª—è–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –∫–ª–∞—Å—Å–∞ Error, –ª–æ–≥–∏—Ä—É–µ–º —Ç–∞–∫–∂–µ —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤
		if (error instanceof Error) {
			logger.error('[üêõ] Stack trace:', error.stack);
		}
	}
};
